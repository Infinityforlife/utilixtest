<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Stocks ‚Äî Dashboard</title>
  <meta name="description" content="Live updating stock prices, customizable notifications, PWA installable" />
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#1e90ff;--muted:#9aa6bf;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#e6eef8;background:linear-gradient(180deg,#071126 0%,#081022 100%)}
    .app{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:20px}
    .controls{display:flex;gap:8px;align-items:center}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    .watchlist{margin-top:18px;display:grid;grid-template-columns:1fr;gap:10px}
    .stock-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:var(--glass)}
    .symbol{font-weight:700}
    .price{font-family:monospace}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer}
    input,select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .muted{color:var(--muted);font-size:13px}
    .positive{color:#6ee7b7}
    .negative{color:#ff7b7b}
    .small{font-size:12px}
    .settings-panel{position:fixed;right:18px;top:60px;width:320px;padding:16px;z-index:60}
    .hidden{display:none}
    .install-btn{display:inline-flex;align-items:center;gap:8px}
    .invalid { color: #ffcccb; font-style: italic; }
    .loading { color: var(--muted); font-style: italic; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Live Stocks</h1>
        <div class="muted small">Add symbols, get desktop notifications, installable as an app</div>
      </div>
      <div class="controls">
        <button id="openSettings">Settings ‚öôÔ∏è</button>
        <button id="requestNotif">Enable Notifications üîî</button>
        <button id="installPWA" class="install-btn hidden">Install App ‚§ì</button>
      </div>
    </header>

    <section class="card">
      <div style="display:flex;gap:12px;align-items:center">
        <input id="symbolInput" placeholder="Add symbol (e.g. AAPL or BTC-USD)" />
        <button id="addSymbol">Add</button>
        <select id="updateInterval">
          <option value="5000">Update every 5s</option>
          <option value="15000">15s</option>
          <option value="30000">30s</option>
          <option value="60000">1m</option>
          <option value="300000">5m</option>
        </select>
      </div>

      <div class="watchlist" id="watchlist"></div>

      <div style="margin-top:12px" class="muted small">Notes: This site calls a secure proxy which uses your Finnhub API key (kept secret on the proxy). Do not embed your key directly in GitHub Pages.</div>
    </section>

    <aside class="card settings-panel hidden" id="settingsPanel">
      <h3>Notification Settings</h3>
      <div style="margin-top:8px">
        <label class="small muted">Default price change threshold (%)</label>
        <input id="defaultThreshold" type="number" min="0" step="0.1" value="1" />
      </div>
      <div style="margin-top:8px">
        <label class="small muted">Notify when price rises above / falls below specific price</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="manualSymbol" placeholder="Symbol" style="width:80px" />
          <input id="manualPrice" placeholder="Price" style="width:100px" />
          <select id="manualWhen"><option value="above">Above</option><option value="below">Below</option></select>
          <button id="addManualAlert">Add</button>
        </div>
      </div>
      <div style="margin-top:12px">
        <label class="small muted">Notification method</label>
        <select id="notifMethod">
          <option value="local">Local Browser Notifications</option>
          <option value="inpage">In-page Alerts</option>
        </select>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button id="saveSettings">Save</button>
        <button id="closeSettings">Close</button>
      </div>
    </aside>
  </div>

<script>
/*
  CONFIG:
  - PROXY_URL: Must point to your deployed proxy endpoint that accepts ?symbol=XXX
    e.g. 'https://your-worker.example.workers.dev/?symbol={SYMBOL}'
  - You can optionally set DIRECT_FINNHUB_KEY (not recommended). If set, the page will call Finnhub directly (key will be public).
*/

const PROXY_URL = 'https://YOUR_PROXY_URL/?symbol={SYMBOL}'; // <- REPLACE with your proxy (Cloudflare Workers or Vercel function)
const DIRECT_FINNHUB_KEY = null; // only set if you understand risks (key will be public)

const THRESHOLD_COOLDOWN_MS = 1000 * 60 * 5;

const DB = {
  async get(key){ const raw = localStorage.getItem(key); return raw?JSON.parse(raw):null },
  async set(key,val){ localStorage.setItem(key,JSON.stringify(val)); return true }
};

let watch = ['AAPL','GOOG','MSFT'];
let settings = { thresholdPercent:1, notifMethod:'local', manualAlerts:[] };
let lastPrices = {};
let lastNotified = {};
let pollTimer = null;

const watchlistEl = document.getElementById('watchlist');
const addBtn = document.getElementById('addSymbol');
const symbolInput = document.getElementById('symbolInput');
const updateInterval = document.getElementById('updateInterval');
const openSettingsBtn = document.getElementById('openSettings');
const settingsPanel = document.getElementById('settingsPanel');
const defaultThreshold = document.getElementById('defaultThreshold');
const saveSettingsBtn = document.getElementById('saveSettings');
const closeSettingsBtn = document.getElementById('closeSettings');
const requestNotifBtn = document.getElementById('requestNotif');
const notifMethod = document.getElementById('notifMethod');
const addManualAlertBtn = document.getElementById('addManualAlert');
const manualSymbol = document.getElementById('manualSymbol');
const manualPrice = document.getElementById('manualPrice');
const manualWhen = document.getElementById('manualWhen');
const installBtn = document.getElementById('installPWA');

function idFor(sym){ return sym.replace(/[^a-z0-9\-_]/gi, '_'); }
function now(){ return Date.now(); }

function renderWatchlist(){
  watchlistEl.innerHTML = '';
  for(const s of watch){
    const safe = idFor(s);
    const row = document.createElement('div'); row.className='stock-row';
    const left = document.createElement('div');
    left.innerHTML = `<div class="symbol">${s}</div>
      <div class="muted small">Last: <span id="last-${safe}">‚Äî</span></div>`;
    const right = document.createElement('div');
    right.innerHTML = `<div class="price loading" id="price-${safe}">Loading‚Ä¶</div>
      <div class="muted small" id="chg-${safe}"></div>`;
    const del = document.createElement('button'); del.textContent='Remove';
    del.onclick = ()=>{ removeSymbol(s) };
    row.appendChild(left); row.appendChild(right); row.appendChild(del);
    watchlistEl.appendChild(row);
  }
}

function addSymbolToWatch(input){
  const s = (input||'').trim().toUpperCase();
  if(!s) return;
  if(watch.includes(s)){ alert(`${s} is already in your watchlist`); return; }
  watch.push(s);
  DB.set('watch', watch);
  renderWatchlist();
  pollPrices();
}

function removeSymbol(s){
  watch = watch.filter(x=>x!==s);
  delete lastPrices[s];
  delete lastNotified[s];
  DB.set('watch', watch);
  renderWatchlist();
}

async function fetchFromProxy(symbol){
  const url = PROXY_URL.replace('{SYMBOL}', encodeURIComponent(symbol));
  const r = await fetch(url, { cache:'no-store' });
  if(!r.ok) {
    console.warn('Proxy returned non-ok', r.status);
    return null;
  }
  const data = await r.json();
  // If proxy forwards Finnhub, data.c contains price
  return data.c ?? data.current ?? data.price ?? data.regularMarketPrice ?? null;
}

async function fetchDirectFinnhub(symbol){
  // Not recommended: exposes key in client. Kept as optional fallback.
  if(!DIRECT_FINNHUB_KEY) return null;
  const url = `https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(symbol)}&token=${DIRECT_FINNHUB_KEY}`;
  const r = await fetch(url, { cache: 'no-store' });
  if(!r.ok) return null;
  const data = await r.json();
  return data.c ?? null;
}

async function fetchPrice(symbol){
  // Try proxy first
  try{
    const p = await fetchFromProxy(symbol);
    if(p != null) return p;
  }catch(e){ console.warn('proxy fetch failed', e); }
  // then optionally direct
  try{
    const d = await fetchDirectFinnhub(symbol);
    if(d != null) return d;
  }catch(e){ console.warn('direct fetch failed', e); }
  return null;
}

async function pollPrices(){
  if(watch.length === 0) return;
  const jobs = watch.map(s => fetchPrice(s).then(price => ({symbol:s, price})).catch(e=>({symbol:s, price:null})));
  const results = await Promise.all(jobs);

  for(const r of results){
    const s = r.symbol;
    const safe = idFor(s);
    const priceEl = document.getElementById(`price-${safe}`);
    const lastEl = document.getElementById(`last-${safe}`);
    const chgEl  = document.getElementById(`chg-${safe}`);
    if(!priceEl || !lastEl || !chgEl) continue;

    const price = r.price;
    if(price == null){
      priceEl.textContent = 'Invalid';
      priceEl.className = 'price invalid';
      chgEl.textContent = '';
      continue;
    }

    const prev = lastPrices[s];
    priceEl.textContent = Number(price).toFixed(2);
    priceEl.className = 'price';
    lastEl.textContent = prev? prev.toFixed(2) : '‚Äî';

    if(typeof prev === 'number' && prev > 0){
      const diff = price - prev;
      const pct = (diff / prev) * 100;
      chgEl.textContent = `${diff>=0?'+':''}${diff.toFixed(2)} (${pct>=0?'+':''}${pct.toFixed(2)}%)`;
      chgEl.className = pct>=0? 'muted small positive':'muted small negative';

      const threshold = Number(settings.thresholdPercent) || 1;
      const lastNotifiedTs = lastNotified[s] || 0;
      if(Math.abs(pct) >= threshold && (now() - lastNotifiedTs) > THRESHOLD_COOLDOWN_MS){
        notify(`${s} moved ${pct.toFixed(2)}%`, `${s}: $${price.toFixed(2)} (${pct>=0?'+':''}${pct.toFixed(2)}%)`);
        lastNotified[s] = now();
        lastPrices[s] = price;
        continue;
      }
    } else {
      chgEl.textContent = '';
    }

    // manual alerts
    if(Array.isArray(settings.manualAlerts) && settings.manualAlerts.length){
      let changed = false;
      for(const a of settings.manualAlerts){
        if(a._triggered) continue;
        if((a.symbol||'').toUpperCase() !== s) continue;
        const target = Number(a.price);
        if(a.when === 'above' && price >= target){ notify(`Alert: ${s} above ${target}`, `${s} is $${price.toFixed(2)}`); a._triggered=true; changed=true; }
        if(a.when === 'below' && price <= target){ notify(`Alert: ${s} below ${target}`, `${s} is $${price.toFixed(2)}`); a._triggered=true; changed=true; }
      }
      if(changed) DB.set('settings', settings).catch(()=>{});
    }

    lastPrices[s] = price;
  }
}

function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  const ms = Number(updateInterval.value) || 5000;
  pollPrices();
  pollTimer = setInterval(pollPrices, ms);
}
updateInterval.onchange = startPolling;

async function requestNotifications(){
  if('Notification' in window){
    const perm = await Notification.requestPermission();
    if(perm === 'granted') alert('Notifications granted');
    else alert('Notifications denied or dismissed');
  } else alert('This browser does not support Notifications API');
}
requestNotifBtn.onclick = requestNotifications;

async function notify(title, body){
  const method = settings.notifMethod || 'local';
  if(method === 'local' && 'Notification' in window && Notification.permission === 'granted'){
    try{ new Notification(title, { body }); }catch(e){ alert(title + '\n' + body); }
  } else { alert(title + '\n' + body); }
}

let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden'); });
installBtn.onclick = async ()=>{ if(deferredPrompt){ deferredPrompt.prompt(); try{ await deferredPrompt.userChoice; }catch(e){} deferredPrompt=null; installBtn.classList.add('hidden'); } };

openSettingsBtn.onclick = ()=>{ settingsPanel.classList.toggle('hidden') };
closeSettingsBtn.onclick = ()=>{ settingsPanel.classList.add('hidden') };
saveSettingsBtn.onclick = async ()=>{
  settings.thresholdPercent = Number(defaultThreshold.value) || 1;
  settings.notifMethod = notifMethod.value;
  await DB.set('settings', settings);
  settingsPanel.classList.add('hidden');
  alert('Settings saved locally');
};

addManualAlertBtn.onclick = async ()=>{
  const sym = (manualSymbol.value||'').trim().toUpperCase();
  const price = Number(manualPrice.value);
  const when = manualWhen.value;
  if(!sym || !price) return alert('Enter symbol and numeric price');
  settings.manualAlerts = settings.manualAlerts || [];
  settings.manualAlerts.push({ symbol: sym, price, when, _triggered: false });
  await DB.set('settings', settings);
  manualSymbol.value=''; manualPrice.value='';
  alert('Manual alert added');
};

addBtn.onclick = ()=>{ addSymbolToWatch(symbolInput.value); symbolInput.value=''; };
symbolInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') addBtn.click(); });

(async function init(){
  try{
    const storedWatch = await DB.get('watch');
    const storedSettings = await DB.get('settings');
    if(Array.isArray(storedWatch) && storedWatch.length) watch = storedWatch;
    if(storedSettings) settings = storedSettings;
    defaultThreshold.value = settings.thresholdPercent ?? 1;
    notifMethod.value = settings.notifMethod ?? 'local';
    renderWatchlist();
    startPolling();
    window.__LIVE_STOCKS = { watch, settings, lastPrices, startPolling, pollPrices };
    if(location.protocol !== 'https:' && location.hostname !== 'localhost'){
      console.warn('Serve over HTTPS or localhost for full PWA/notifications behavior.');
    }
  }catch(e){ console.error('Initialization failed', e); }
})();
</script>
</body>
</html>
